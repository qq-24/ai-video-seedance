# AI 视频生成工具本地化改造计划

## 一、改造目标

将项目从 Supabase 云服务迁移到完全本地化部署，实现：

* 本地数据库（SQLite，零配置）

* 本地文件存储

* 简化的认证系统（单用户密码保护）

## 二、技术选型

| 功能  | 当前方案              | 本地化方案               | 理由                      |
| --- | ----------------- | ------------------- | ----------------------- |
| 数据库 | Supabase Postgres | **Prisma + SQLite** | 零配置，单文件，个人使用足够          |
| 认证  | Supabase Auth     | **简单密码保护**          | 单用户无需复杂认证               |
| 存储  | Supabase Storage  | **本地文件系统**          | 简单直接，文件存 public/uploads |
| 会话  | Supabase Session  | **Iron Session**    | 轻量级加密 Cookie 会话         |

## 三、改造范围

### 需要修改的文件（共 30+ 个）

```
src/
├── lib/
│   ├── supabase/          → 删除，替换为 lib/db/client.ts
│   ├── db/                → 重写所有文件
│   └── auth/              → 新增，认证逻辑
├── components/auth/       → 简化为单一密码输入
├── app/
│   ├── api/               → 重写所有路由
│   ├── login/             → 简化
│   └── register/          → 删除
└── middleware.ts          → 重写
```

## 四、实施阶段

### Phase 1: 数据库层改造（核心）

**任务清单：**

1. **安装依赖**

   ```bash
   npm install prisma @prisma/client iron-session
   npm uninstall @supabase/ssr @supabase/supabase-js
   ```

2. **初始化 Prisma + SQLite**

   * 创建 `prisma/schema.prisma` 定义所有表结构

   * 表：projects, scenes, images, videos, materials, video\_chains, video\_chain\_items, settings

3. **创建数据库客户端**

   * `src/lib/db/client.ts` - Prisma 客户端单例

4. **重写数据库操作文件**

   * `src/lib/db/projects.ts`

   * `src/lib/db/scenes.ts`

   * `src/lib/db/media.ts`

   * `src/lib/db/materials.ts`

   * `src/lib/db/video-chains.ts`

### Phase 2: 认证系统简化

**任务清单：**

1. **创建认证模块**

   * `src/lib/auth/session.ts` - Iron Session 配置

   * `src/lib/auth/config.ts` - 密码配置（环境变量）

2. **简化登录页面**

   * 删除注册功能

   * 登录页改为密码输入

   * 首次访问自动设置密码

3. **重写中间件**

   * `src/middleware.ts` - 简单的会话验证

### Phase 3: 存储系统本地化

**任务清单：**

1. **创建存储模块**

   * `src/lib/storage/local.ts` - 本地文件存储操作

   * 上传到 `public/uploads/` 目录

2. **重写存储相关 API**

   * `src/app/api/storage/signed-urls/route.ts` → 返回静态 URL

   * 修改所有上传逻辑

3. **更新媒体文件处理**

   * 图片存储路径：`public/uploads/images/`

   * 视频存储路径：`public/uploads/videos/`

   * 素材存储路径：`public/uploads/materials/`

### Phase 4: API 路由重写

**任务清单：**

1. **项目相关 API**

   * `/api/projects` - 移除 user\_id 验证

   * `/api/projects/[id]` - 简化权限检查

2. **场景相关 API**

   * 所有场景 API 移除用户验证

3. **素材相关 API**

   * 重写上传逻辑使用本地存储

4. **生成相关 API**

   * 保持 AI 调用逻辑不变

   * 修改存储逻辑

### Phase 5: 前端调整

**任务清单：**

1. **删除认证组件**

   * 删除 `RegisterForm.tsx`

   * 简化 `LoginForm.tsx`

2. **更新页面**

   * 删除 `/register` 页面

   * 简化 `/login` 页面

3. **移除 Supabase Provider**

   * 更新 `Providers.tsx`

### Phase 6: 配置与清理

**任务清单：**

1. **更新环境变量**

   * 删除 Supabase 相关变量

   * 添加 `AUTH_PASSWORD` 和 `SESSION_SECRET`

2. **删除废弃文件**

   * `src/lib/supabase/` 目录

   * `src/app/register/` 目录

3. **更新文档**

   * README.md

   * .env.local.example

## 五、数据库 Schema 设计

```prisma
// prisma/schema.prisma

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

generator client {
  provider = "prisma-client-js"
}

model Project {
  id          String   @id @default(uuid())
  title       String
  story       String?
  style       String?
  stage       String   @default("draft")
  mode        String   @default("story")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  scenes      Scene[]
  videoChains VideoChain[]
}

model Scene {
  id                   String   @id @default(uuid())
  projectId            String
  orderIndex           Int
  description          String
  descriptionConfirmed Boolean @default(false)
  imageStatus          String   @default("pending")
  imageConfirmed       Boolean  @default(false)
  videoStatus          String   @default("pending")
  videoConfirmed       Boolean  @default(false)
  createdAt            DateTime @default(now())
  project              Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  images               Image[]
  videos               Video[]
  materials            Material[]
}

model Image {
  id          String   @id @default(uuid())
  sceneId     String
  storagePath String
  url         String
  width       Int?
  height      Int?
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  scene       Scene    @relation(fields: [sceneId], references: [id], onDelete: Cascade)
}

model Video {
  id          String   @id @default(uuid())
  sceneId     String
  storagePath String
  url         String
  duration    Float?
  taskId      String?
  version     Int      @default(1)
  createdAt   DateTime @default(now())
  scene       Scene    @relation(fields: [sceneId], references: [id], onDelete: Cascade)
  chainItems  VideoChainItem[]
  parentItems VideoChainItem[] @relation("ParentVideo")
}

model Material {
  id          String   @id @default(uuid())
  sceneId     String
  type        String   // audio, video, image, text
  storagePath String
  url         String
  metadata    String?  // JSON string
  orderIndex  Int      @default(0)
  createdAt   DateTime @default(now())
  scene       Scene    @relation(fields: [sceneId], references: [id], onDelete: Cascade)
}

model VideoChain {
  id        String   @id @default(uuid())
  projectId String
  name      String?
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  items     VideoChainItem[]
}

model VideoChainItem {
  id            String   @id @default(uuid())
  chainId       String
  videoId       String
  orderIndex    Int      @default(0)
  parentVideoId String?
  createdAt     DateTime @default(now())
  chain         VideoChain @relation(fields: [chainId], references: [id], onDelete: Cascade)
  video         Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)
  parentVideo   Video?   @relation("ParentVideo", fields: [parentVideoId], references: [id], onDelete: SetNull)
}

model Setting {
  id        String   @id @default("app")
  password  String   // hashed password
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

## 六、新的目录结构

```
hello-nextjs/
├── prisma/
│   ├── schema.prisma
│   └── dev.db              # SQLite 数据库文件
├── public/
│   └── uploads/            # 本地存储
│       ├── images/
│       ├── videos/
│       └── materials/
├── src/
│   ├── lib/
│   │   ├── db/
│   │   │   ├── client.ts   # Prisma 客户端
│   │   │   ├── projects.ts
│   │   │   ├── scenes.ts
│   │   │   ├── media.ts
│   │   │   ├── materials.ts
│   │   │   └── video-chains.ts
│   │   ├── auth/
│   │   │   ├── session.ts  # Iron Session
│   │   │   └── config.ts
│   │   ├── storage/
│   │   │   └── local.ts    # 本地文件存储
│   │   └── ai/             # 保持不变
│   └── ...
└── .env.local
    AUTH_PASSWORD=your-password
    SESSION_SECRET=random-32-char-string
```

## 七、工作量估算

| 阶段              | 预计时间   | 优先级 |
| --------------- | ------ | --- |
| Phase 1: 数据库层   | 2-3 小时 | P0  |
| Phase 2: 认证系统   | 1-2 小时 | P0  |
| Phase 3: 存储系统   | 1-2 小时 | P1  |
| Phase 4: API 重写 | 2-3 小时 | P0  |
| Phase 5: 前端调整   | 1 小时   | P1  |
| Phase 6: 配置清理   | 0.5 小时 | P2  |

**总计：8-12 小时**

## 八、风险与注意事项

1. **数据迁移**：现有 Supabase 数据无法自动迁移，需要重新开始
2. **AI 服务**：智谱 AI 和火山引擎的 API Key 仍需配置
3. **备份**：SQLite 数据库文件需要定期备份
4. **性能**：SQLite 适合个人使用，并发性能有限

## 九、实施顺序

```
Phase 1 (数据库) ──→ Phase 4 (API) ──→ Phase 5 (前端)
        │                   ↑
        └──→ Phase 2 (认证) ─┘
        │
        └──→ Phase 3 (存储) ──→ Phase 6 (清理)
```

建议按以下顺序执行：

1. 先完成数据库层（Phase 1）
2. 并行完成认证（Phase 2）和存储（Phase 3）
3. 重写 API（Phase 4）
4. 调整前端（Phase 5）
5. 清理配置（Phase 6）

